<!DOCTYPE html>
<html>
<head>
  <title>Earn Coins</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #1e1e1e;
      --card: #2c2c2c;
      --text: #f0f0f0;
      --accent: #4caf50;
    }
    body.light {
      --bg: #f0f0f0;
      --card: #ffffff;
      --text: #1e1e1e;
      --accent: #4caf50;
    }
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
    }
    header {
      background-color: var(--card);
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      border-bottom: 1px solid #444;
    }
    .logo {
      font-size: 1.5em;
      font-weight: bold;
      color: var(--accent);
    }
    .tabs {
      display: flex;
      gap: 20px;
      margin: 20px;
      flex-wrap: wrap;
    }
    .tabs button {
      background: none;
      border: none;
      color: var(--text);
      font-weight: 500;
      cursor: pointer;
      padding: 8px 12px;
      border-radius: 5px;
    }
    .tabs button:hover {
      background-color: var(--accent);
      color: white;
    }
    .filters {
      display: flex;
      gap: 10px;
      margin: 0 20px 20px;
      flex-wrap: wrap;
    }
    .filters button {
      background-color: var(--card);
      border: 1px solid #555;
      color: var(--text);
      padding: 6px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
    .filters button.active {
      background-color: var(--accent);
      color: white;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
      padding: 0 20px 60px;
    }
    .task-card {
      background-color: var(--card);
      border-radius: 10px;
      padding: 10px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .task-card:hover {
      transform: scale(1.05);
    }
    .task-card img {
      width: 80px;
      height: 80px;
      border-radius: 10px;
      object-fit: cover;
    }
    .task-title {
      margin: 10px 0 5px;
      font-weight: bold;
      font-size: 0.95em;
    }
    .task-reward {
      color: var(--accent);
      font-size: 0.85em;
    }
    .toggle-theme {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--accent);
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">Coinexia</div>
  </header>

  <div class="tabs">
    <button onclick="filterTab('offers')">Offers</button>
    <button onclick="filterTab('surveys')">Surveys</button>
    <button onclick="filterTab('all')">All Offers</button>
    <button onclick="filterTab('progress')">In Progress</button>
    <button onclick="filterTab('history')">Earning History</button>
  </div>

  <div class="filters">
    <button onclick="filterPlatform('all')" class="active">All</button>
    <button onclick="filterPlatform('android')">Android</button>
    <button onclick="filterPlatform('ios')">iOS</button>
    <button onclick="filterPlatform('web')">Web</button>
  </div>

  <div class="grid" id="taskGrid">
    <!-- Tasks will be loaded here -->
  </div>

  <button class="toggle-theme" onclick="toggleTheme()">Toggle Theme</button>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDJmHmlTwvpDwEt3EJc6KVpi4X8meZeffc",
    authDomain: "coinexia-748b6.firebaseapp.com",
    projectId: "coinexia-748b6",
    storageBucket: "coinexia-748b6.appspot.com",
    messagingSenderId: "235020899567",
    appId: "1:235020899567:web:0d4b031bb45ee6990a371a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  let allTasks = [];
  let currentPlatform = "all";

  auth.onAuthStateChanged(async user => {
    if (user) {
      const uid = user.uid;
      const snapshot = await db.collection("users").doc(uid).collection("tasks").get();
      allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTasks();
    } else {
      window.location.href = "index.html";
    }
  });

  function renderTasks() {
    const grid = document.getElementById("taskGrid");
    grid.innerHTML = "";

    const filtered = allTasks.filter(task => {
      return currentPlatform === "all" || task.platform.toLowerCase() === currentPlatform;
    });

    filtered.forEach(task => {
      const card = document.createElement("div");
      card.className = "task-card";
      card.onclick = () => openPreview(task);
      card.innerHTML = `
        <img src="${task.thumbnail}" alt="${task.title}">
        <div class="task-title">${task.title}</div>
        <div class="task-reward">${task.reward.toLocaleString()} Coins</div>
      `;
      grid.appendChild(card);
    });
  }

  function filterPlatform(platform) {
    currentPlatform = platform;
    document.querySelectorAll(".filters button").forEach(btn => btn.classList.remove("active"));
    document.querySelector(`.filters button[onclick="filterPlatform('${platform}')"]`).classList.add("active");
    renderTasks();
  }

  function toggleTheme() {
    const current = document.body.classList.contains("light");
    if (current) {
      document.body.classList.remove("light");
      localStorage.setItem("theme", "dark");
    } else {
      document.body.classList.add("light");
      localStorage.setItem("theme", "light");
    }
  }

  window.onload = () => {
    const savedTheme = localStorage.getItem("theme");
    if (savedTheme === "light") {
      document.body.classList.add("light");
    }
  };

  function openPreview(task) {
    const modal = document.createElement("div");
    modal.style.position = "fixed";
    modal.style.top = "0";
    modal.style.left = "0";
    modal.style.width = "100%";
    modal.style.height = "100%";
    modal.style.background = "rgba(0,0,0,0.8)";
    modal.style.display = "flex";
    modal.style.justifyContent = "center";
    modal.style.alignItems = "center";
    modal.style.zIndex = "9999";

    modal.innerHTML = `
      <div style="background: var(--card); padding: 20px; border-radius: 10px; max-width: 400px; text-align: center; position: relative;">
        <button onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 10px; background: red; color: white; border: none; padding: 5px 10px; border-radius: 5px;">❌</button>
        <img src="${task.thumbnail}" style="width: 100px; height: 100px; border-radius: 10px;"><br><br>
        <h3>${task.title}</h3>
        <p>${task.description}</p>
        <p><strong>Instructions:</strong> ${task.instructions}</p>
        <p><strong>Reward:</strong> ${task.reward.toLocaleString()} Coins</p>
        <a href="${task.link}" target="_blank"><button class="btn">Download</button></a>
        ${!task.completed ? `<br><br><button class="btn" onclick="completeTask('${task.id}', ${task.reward}); this.parentElement.parentElement.remove()">Mark as Complete</button>` : `<p style="color: var(--accent); font-weight: bold;">✅ Completed</p>`}
      </div>
    `;
    document.body.appendChild(modal);
  }

  async function completeTask(taskId, reward) {
    const uid = auth.currentUser.uid;
    const taskRef = db.collection("users").doc(uid).collection("tasks").doc(taskId);
    await taskRef.update({ completed: true });
    await db.collection("users").doc(uid).update({
      points: firebase.firestore.FieldValue.increment(reward)
    });
    alert(`You earned ${reward.toLocaleString()} Coins!`);
    const snapshot = await db.collection("users").doc(uid).collection("tasks").get();
    allTasks = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderTasks();
  }
</script>
</body>
</html>

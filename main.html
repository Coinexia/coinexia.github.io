<script>
  const firebaseConfig = {
    apiKey: "AIzaSyDJmHmlTwvpDwEt3EJc6KVpi4X8meZeffc",
    authDomain: "coinexia-748b6.firebaseapp.com",
    projectId: "coinexia-748b6",
    storageBucket: "coinexia-748b6.appspot.com",
    messagingSenderId: "235020899567",
    appId: "1:235020899567:web:0d4b031bb45ee6990a371a"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();
  const auth = firebase.auth();

  function getRank(points) {
    if (points >= 5000) return "Gold";
    if (points >= 1000) return "Silver";
    return "Bronze";
  }
  function getMultiplier(rank) {
    if (rank === "Gold") return "+20%";
    if (rank === "Silver") return "+15%";
    return "+5%";
  }
  function getProgress(points) {
    if (points >= 5000) return 100;
    if (points >= 1000) return Math.floor((points - 1000) / 4000 * 100);
    return Math.floor(points / 1000 * 100);
  }

  auth.onAuthStateChanged(async user => {
    if (user) {
      const uid = user.uid;
      document.getElementById('avatar').textContent = user.displayName ? user.displayName.charAt(0).toUpperCase() : '?';
      document.getElementById('profileName').textContent = `Name: ${user.displayName}`;

      const joinTimestamp = user.metadata?.creationTime;
      if (joinTimestamp) {
        const formattedDate = new Date(joinTimestamp).toDateString();
        document.getElementById('joinDate').textContent = `Joined: ${formattedDate}`;
      } else {
        document.getElementById('joinDate').textContent = `Joined: Unknown`;
      }

      const userDoc = await db.collection('users').doc(uid).get();
      const data = userDoc.exists ? userDoc.data() : {};
      const points = data.points || 0;
      const referrals = data.referrals || 0;
      const streak = data.streak || 0;

      const rank = getRank(points);
      const multiplier = getMultiplier(rank);
      const progress = getProgress(points);

      document.getElementById('points').textContent = `${points} pts`;
      document.getElementById('rankLabel').textContent = `Rank: ${rank}`;
      document.getElementById('multiplierLabel').textContent = `Bonus: ${multiplier}`;
      document.getElementById('referralCount').textContent = `Referrals: ${referrals}`;
      document.getElementById('streakCount').textContent = `Streak: ${streak} days`;
      document.getElementById('rankProgress').style.width = `${progress}%`;
      document.getElementById('referralLink').textContent = `https://coinexia.github.io/?ref=${uid}`;

      loadLeaderboard();
      loadTaskHistory(uid);
    } else {
      window.location.href = "index.html";
    }
  });

  async function loadLeaderboard() {
    const snapshot = await db.collection('users').orderBy('points', 'desc').limit(5).get();
    const list = document.getElementById('leaderboardList');
    list.innerHTML = '';
    snapshot.forEach((doc, index) => {
      const data = doc.data();
      const name = data.displayName || "Anonymous";
      const points = data.points || 0;
      const li = document.createElement('li');
      li.textContent = `#${index + 1} ${name} — ${points} pts`;
      list.appendChild(li);
    });
  }

  async function loadTaskHistory(uid) {
    const historyRef = db.collection('users').doc(uid).collection('history').orderBy('timestamp', 'desc').limit(5);
    const snapshot = await historyRef.get();
    const list = document.getElementById('taskHistoryList');
    list.innerHTML = '';
    snapshot.forEach(doc => {
      const data = doc.data();
      const li = document.createElement('li');
      const time = new Date(data.timestamp).toLocaleString();
      li.textContent = `${data.action} — ${data.points} pts (${time})`;
      list.appendChild(li);
    });
  }

  function earnPoints() {
    alert("Points earning system coming soon!");
  }

  function logout() {
    auth.signOut().then(() => {
      window.location.href = "index.html";
    });
  }

  function toggleTheme() {
    document.body.classList.toggle('light');
  }

  setTimeout(() => {
    document.getElementById('promoBanner').style.top = '0px';
    setTimeout(() => {
      document.getElementById('promoBanner').style.top = '-100px';
    }, 5000);
  }, 1000);
</script>
